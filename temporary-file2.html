<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // -----------------------------------------
      // 31 _Promise

      class _Promise {
        status = "pending";
        value = "";
        reason = "";

        onFulfilledCallback = [];
        onRejectedCallback = [];

        constructor(executor) {
          executor(this.resolve, this.reject);
        }

        resolve = (value) => {
          if (this.status === "pending") {
            this.status = "fulfilled";
            this.value = value;
            this.onFulfilledCallback.forEach((fn) => fn(value));
          }
        };

        reject = (reason) => {
          if (this.status === "pending") {
            this.status = "rejected";
            this.reason = reason;
            this.onRejectedCallback.forEach((fn) => fn(reason));
          }
        };

        then = (onFulfilled, onRejected) => {
          if (this.status === "fulfilled") {
            setTimeout(() => onFulfilled(this.value));
          }

          if (this.status === "rejected") {
            setTimeout(() => onRejected(this.reason));
          }

          if (this.status === "pending") {
            this.onFulfilledCallback.push((value) => setTimeout(() => onRejected(value)));
            this.onRejectedCallback.push((reason) => setTimeout(() => onRejected(reason)));
          }
        };
      }

      Promise._all = (values) => {
        return new Promise((resolve, reject) => {
          const result = [];
          let count = 0;
          const arr = Array.from(values);

          arr.forEach((_promise, index) => {
            Promise.resolve(_promise).then((value) => {
              // result.push(value);
              // if (result.length === arr.length) return solve(result);

              result[index] = value;
              count++;
              if (count === arr.length) return resolve(result);
            }, reject);
          });
        });
      };

      Promise._race = (values) => {
        return new Promise((resolve, reject) => {
          const arr = Array.from(values);

          arr.forEach((_promise, index) => {
            Promise.resolve(_promise).then(resolve, reject);
          });
        });
      };

      // 1
      // _Promise()
      new _Promise((resolve, reject) => {
        setTimeout(() => {
          console.warn(1);
          resolve(4);
          console.warn(2);
        });
      }).then(
        (value) => console.warn("value", value),
        (reason) => console.warn("reason", reason)
      );
      console.log(3);

      // 2
      // Promise._all()
      const p1 = new Promise((resolve) => setTimeout(() => resolve(3), 3000));
      const p2 = new Promise((resolve) => setTimeout(() => resolve(1), 1000));
      const list = [p1, p2];
      Promise.all(list).then((values) => console.log("original", values));
      Promise._all(list).then((values) => console.log("implementation", values));

      // 3
      // Promise._race()
      // 测试
      const p11 = new Promise((resolve) => setTimeout(() => resolve(3), 3000));
      const p22 = new Promise((resolve) => setTimeout(() => resolve(2), 2000));
      const list33 = [p11, p22];
      Promise.race(list33).then((values) => console.log(values));
      Promise._race(list33).then((values) => console.log(values));
    </script>
  </body>
</html>
